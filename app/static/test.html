<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOM2Pic - Local Test Mode</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="bg-warning text-dark py-3">
        <div class="container">
            <h1 class="h3 mb-0">üß™ BOM2Pic - TEST MODE</h1>
            <p class="mb-0 small">Local testing without authentication</p>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container py-4">
        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Processing Section -->
        <div id="processingSection">
            <form id="processingForm" class="row g-4">
                <!-- File Upload -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <span class="badge bg-primary me-2">1</span>
                            <strong>Upload Excel Files (.xlsx)</strong>
                        </div>
                        <div class="card-body">
                            <input type="file" class="form-control" id="fileInput" multiple accept=".xlsx" required>
                            <div class="form-text">Select one or more .xlsx files containing images</div>
                        </div>
                    </div>
                </div>

                <!-- Column Selection -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <span class="badge bg-primary me-2">2</span>
                            <strong>Column with Images</strong>
                        </div>
                        <div class="card-body">
                            <input type="text" class="form-control" id="imageColumn" placeholder="e.g., A" required>
                            <div class="form-text">Enter column letter (A, B, C, etc.)</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <span class="badge bg-primary me-2">2</span>
                            <strong>Column with Names/IDs</strong>
                        </div>
                        <div class="card-body">
                            <input type="text" class="form-control" id="nameColumn" placeholder="e.g., B" required>
                            <div class="form-text">Enter column letter (A, B, C, etc.)</div>
                        </div>
                    </div>
                </div>

                <!-- Process Button -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <span class="badge bg-success me-2">3</span>
                            <strong>Extract Images</strong>
                        </div>
                        <div class="card-body text-center">
                            <button type="submit" class="btn btn-success btn-lg px-5" id="processBtn">
                                üöÄ Process Files (TEST MODE)
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Instructions -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="alert alert-info">
                    <h5>üìã Testing Instructions:</h5>
                    <ol>
                        <li>Create some Excel files with embedded images</li>
                        <li>Upload them using the form above</li>
                        <li>Specify which columns contain images and names</li>
                        <li>Click "Process Files" to extract images</li>
                        <li>Download the ZIP file with organized images</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Simple test mode processing
        document.getElementById('processingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const files = document.getElementById('fileInput').files;
            const imageColumn = document.getElementById('imageColumn').value.trim();
            const nameColumn = document.getElementById('nameColumn').value.trim();
            const processBtn = document.getElementById('processBtn');
            
            if (!files.length) {
                alert('Please select Excel files');
                return;
            }
            
            if (!imageColumn || !nameColumn) {
                alert('Please specify both image and name columns');
                return;
            }
            
            if (imageColumn === nameColumn) {
                alert('Image and name columns must be different');
                return;
            }
            
            // Show processing state
            processBtn.disabled = true;
            processBtn.innerHTML = '‚è≥ Processing...';
            
            try {
                const formData = new FormData();
                for (let file of files) {
                    formData.append('files', file);
                }
                formData.append('imageColumn', imageColumn);
                formData.append('nameColumn', nameColumn);
                
                const response = await fetch('/process', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    // Download the ZIP file
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = response.headers.get('Content-Disposition')?.split('filename=')[1] || 'images.zip';
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    // Show success message
                    const processed = response.headers.get('X-B2P-Processed') || '?';
                    const saved = response.headers.get('X-B2P-Saved') || '?';
                    const duplicates = response.headers.get('X-B2P-Duplicate') || '?';
                    
                    document.getElementById('alertContainer').innerHTML = `
                        <div class="alert alert-success alert-dismissible fade show">
                            <strong>‚úÖ Success!</strong> Processed ${processed} images, saved ${saved}, found ${duplicates} duplicates.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                } else {
                    const error = await response.text();
                    throw new Error(error);
                }
            } catch (error) {
                console.error('Processing error:', error);
                document.getElementById('alertContainer').innerHTML = `
                    <div class="alert alert-danger alert-dismissible fade show">
                        <strong>‚ùå Error:</strong> ${error.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            } finally {
                processBtn.disabled = false;
                processBtn.innerHTML = 'üöÄ Process Files (TEST MODE)';
            }
        });
    </script>
</body>
</html>
